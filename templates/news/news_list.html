{% extends 'base.html' %}
{% load static %}
{% load news_filters %}

{% block content %}
<div class="w-full px-2">
    <!-- ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº (Í≥µÌÜµ) -->
    <div class="flex justify-end mb-2">
        <div class="flex items-center gap-2">
            <span id="countdown">05:00</span>
            <button onclick="location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">
                ÏÉàÎ°úÍ≥†Ïπ®
            </button>
        </div>
    </div>

    {% if request.resolver_match.url_name == 'top_articles' %}
        <div class="w-full">
            <!-- ÏÉÅÎã® ÏòÅÏó≠ÏùÑ 2Îã® Í∑∏Î¶¨ÎìúÎ°ú Î∂ÑÌï† -->
            <div class="grid grid-cols-2 gap-8">
                <!-- ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º ÏÑπÏÖò (ÏôºÏ™Ω) -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º
                        <span class="text-gray-500" id="filteredCount"></span>
                    </h1>
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex gap-4 mb-4">
                            <select id="companyFilter" class="border rounded-lg px-3 py-2 text-sm">
                                <option value="" selected>ÏÑ†ÌÉùÏóÜÏùå</option>
                                <option value="all">Ï†ÑÏ≤¥ Ïñ∏Î°†ÏÇ¨</option>
                                {% for company, articles in news_by_company.items %}
                                <option value="{{ company }}">{{ company }}</option>
                                {% endfor %}
                            </select>
                            
                            <select id="keywordFilter" class="border rounded-lg px-3 py-2 text-sm">
                                <option value="" selected>ÏÑ†ÌÉùÏóÜÏùå</option>
                                <option value="all">Ï†ÑÏ≤¥ ÌÇ§ÏõåÎìú</option>
                                {% for keyword, articles in keyword_articles.items %}
                                <option value="{{ keyword }}">{{ keyword }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="filteredArticles" class="space-y-2">
                            <!-- ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                </div>

                <!-- AI Î∂ÑÏÑù Í≤∞Í≥º ÏÑπÏÖò (Ïò§Î•∏Ï™Ω) -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">AI Ìä∏Î†åÎìú Î∂ÑÏÑù</h1>
                    <div class="bg-white rounded-lg shadow p-4">
                        {% if llm_analysis %}
                            <div class="prose max-w-none space-y-4">
                                <!-- Ï£ºÏöî Ìä∏Î†åÎìú ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-blue-600">
                                        <span class="mr-2">üîç</span>Ï£ºÏöî Ìä∏Î†åÎìú
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.trends|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>

                                <!-- ÌÇ§ÏõåÎìú Ïó∞Í¥ÄÏÑ± ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-green-600">
                                        <span class="mr-2">üîó</span>ÌÇ§ÏõåÎìú Ïó∞Í¥ÄÏÑ±
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.relations|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>

                                <!-- ÌäπÏù¥ÏÇ¨Ìï≠ ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-purple-600">
                                        <span class="mr-2">üí°</span>ÌäπÏù¥ÏÇ¨Ìï≠
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.insights|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-gray-500 text-center py-4">
                                <p>Î∂ÑÏÑù Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ÌïòÎã®Ïùò Í∏∞Ï°¥ ÏÑπÏÖòÎì§ -->
            <div class="grid grid-cols-2 gap-8 mt-8">
                <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨ ÏÑπÏÖò -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        Ïñ∏Î°†ÏÇ¨Î≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨
                        <span class="text-gray-500">({{ article_count }}Í±¥)</span>
                    </h1>
                    
                    {% if news_by_company %}
                        <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Í∏∞ÏÇ¨ ÌëúÏãú (Í∞ÑÍ≤© Ï∂ïÏÜå) -->
                        <div class="space-y-2">  <!-- space-y-4ÏóêÏÑú space-y-2Î°ú Î≥ÄÍ≤Ω -->
                            {% for company, articles in news_by_company.items %}
                            <div class="bg-white rounded-lg shadow p-2" data-company="{{ company }}">  <!-- data-company Ï∂îÍ∞Ä -->
                                <div class="flex items-center gap-1 mb-2 pb-1 border-b">  <!-- gap-2‚Üígap-1, pb-2‚Üípb-1 -->
                                    <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                                    <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                                </div>
                                <div class="space-y-1.5">  <!-- space-y-2ÏóêÏÑú space-y-1.5Î°ú Î≥ÄÍ≤Ω -->
                                    {% for article in articles %}
                                    <div class="flex gap-1.5 article-item" data-keyword="{{ article.title }}">  <!-- article-itemÍ≥º data-keyword Ï∂îÍ∞Ä -->
                                        <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">  <!-- w-5ÏóêÏÑú w-4Î°ú Î≥ÄÍ≤Ω -->
                                            {{ article.rank }}
                                        </span>
                                        <a href="{{ article.url }}" target="_blank" 
                                           class="text-sm hover:text-blue-600 flex-1">
                                            {{ article.title }}
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Í∏∞Ï°¥ Í∏∞ÏÇ¨ Î™©Î°ù ÌëúÏãú Ïú†ÏßÄ -->
                        <div class="space-y-4">
                            {% for article in articles %}
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="flex flex-col gap-2">
                                    <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                                    <a href="{{ article.url }}" target="_blank" 
                                       class="text-lg hover:text-blue-600">
                                        {{ article.title }}
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-gray-500 text-center py-8">Í¥ÄÎ†® Í∏∞ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- ÌÇ§ÏõåÎìúÎ≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨ ÏÑπÏÖò -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        ÌÇ§ÏõåÎìúÎ≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨
                        <span class="text-gray-500">({{ total_keyword_articles }}Í±¥)</span>
                    </h1>
                    
                    <div class="space-y-2">
                        {% for keyword, articles in keyword_articles.items %}
                        <div class="bg-white rounded-lg shadow p-3">
                            <div class="flex items-center gap-2 mb-2 pb-2 border-b whitespace-nowrap">  <!-- whitespace-nowrap Ï∂îÍ∞Ä -->
                                <span class="text-lg font-bold text-blue-600 flex-shrink-0">"{{ keyword }}" Í¥ÄÎ†®</span>  <!-- flex-shrink-0 Ï∂îÍ∞Ä -->
                                <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                            </div>
                            <div class="space-y-2">
                                {% for article in articles %}
                                <div class="flex gap-2 whitespace-nowrap overflow-hidden">  <!-- Ïª®ÌÖåÏù¥ÎÑàÏóê whitespace-nowrap Ï∂îÍ∞Ä -->
                                    <span class="text-sm text-gray-400 flex-shrink-0">{{ article.company_name }}</span>
                                    <a href="{{ article.url }}" target="_blank" 
                                       class="text-sm hover:text-blue-600 truncate">  <!-- flex-1 Ï†úÍ±∞ÌïòÍ≥† truncate Ï∂îÍ∞Ä -->
                                        {{ article.title }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% elif keyword %}
        <!-- ÌÇ§ÏõåÎìú Í≤ÄÏÉâ Í≤∞Í≥º -->
        <div class="mb-6 max-w-3xl ml-8">
            <h1 class="text-2xl font-bold mb-4">
                "{{ keyword }}" Í¥ÄÎ†® Í∏∞ÏÇ¨
                <span class="text-gray-500">({{ article_count }}Í±¥)</span>
            </h1>
            
            {% if news_by_company %}
                <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Í∏∞ÏÇ¨ ÌëúÏãú (Í∞ÑÍ≤© Ï∂ïÏÜå) -->
                <div class="space-y-2">  <!-- space-y-4ÏóêÏÑú space-y-2Î°ú Î≥ÄÍ≤Ω -->
                    {% for company, articles in news_by_company.items %}
                    <div class="bg-white rounded-lg shadow p-2">  <!-- p-3ÏóêÏÑú p-2Î°ú Î≥ÄÍ≤Ω -->
                        <div class="flex items-center gap-1 mb-2 pb-1 border-b">  <!-- gap-2‚Üígap-1, pb-2‚Üípb-1 -->
                            <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                            <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                        </div>
                        <div class="space-y-1.5">  <!-- space-y-2ÏóêÏÑú space-y-1.5Î°ú Î≥ÄÍ≤Ω -->
                            {% for article in articles %}
                            <div class="flex gap-1.5">  <!-- gap-2ÏóêÏÑú gap-1.5Î°ú Î≥ÄÍ≤Ω -->
                                <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">  <!-- w-5ÏóêÏÑú w-4Î°ú Î≥ÄÍ≤Ω -->
                                    {{ article.rank }}
                                </span>
                                <a href="{{ article.url }}" target="_blank" 
                                   class="text-sm hover:text-blue-600 flex-1">
                                    {{ article.title }}
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Í∏∞Ï°¥ Í∏∞ÏÇ¨ Î™©Î°ù ÌëúÏãú Ïú†ÏßÄ -->
                <div class="space-y-4">
                    {% for article in articles %}
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                            <a href="{{ article.url }}" target="_blank" 
                               class="text-lg hover:text-blue-600">
                                {{ article.title }}
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-8">Í¥ÄÎ†® Í∏∞ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

    {% else %}
        <!-- Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§ Îû≠ÌÇπ (Î©îÏù∏) -->
        <div class="mb-3">
            <div class="flex justify-between gap-8">
                <!-- Ïã§ÏãúÍ∞Ñ Ï£ºÏöî Îâ¥Ïä§ ÏÑπÏÖò -->
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <h1 class="text-xl font-bold">Ïã§ÏãúÍ∞Ñ Ï£ºÏöî Îâ¥Ïä§</h1>
                        <span class="text-sm text-gray-500">
                            ({{ last_update|date:'Y.m.d H:i' }} Í∏∞Ï§Ä)
                        </span>
                    </div>
                    <div class="grid gap-1">
                        {% for item in daily_rankings %}
                        <div class="bg-white rounded shadow-sm p-2">
                            <div class="flex flex-col gap-1">
                                <span class="text-base font-bold text-blue-600">{{ item.company_name }}</span>
                                <a href="{{ item.url }}" target="_blank" class="text-base hover:text-blue-600">{{ item.title }}</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Ï£ºÏöî ÌÇ§ÏõåÎìú ÏÑπÏÖò -->
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2">
                        <h1 class="text-xl font-bold">Ï§ëÏöî ÌÇ§ÏõåÎìú</h1>
                    </div>
                    <div class="grid gap-1">
                        {% for keyword, count, keyword_group in keyword_rankings %}
                        <div class="bg-white rounded shadow-sm p-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 w-32">
                                    <span class="text-base font-bold w-4">{{ forloop.counter }}</span>
                                    <a href="{% url 'news:keyword_articles' keyword=keyword %}" 
                                       class="text-blue-600 hover:text-blue-800 text-base font-medium 
                                              transition-colors flex items-center gap-1 whitespace-nowrap">
                                        {{ keyword }}
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </a>
                                </div>
                                <!-- Ïä¨ÎùºÏù¥Îçî Ïª®ÌÖåÏù¥ÎÑà ÏàòÏ†ï: Í∞ÑÍ≤© Ï§ÑÏù¥Í≥† ÎÑàÎπÑ ÌôïÏû• -->
                                <div class="relative w-[36rem] ml-1 overflow-hidden h-6">
                                    <div id="keywordSlider{{ forloop.counter }}" class="flex flex-col transition-transform duration-500">
                                        {% for item in news_items %}
                                            {% if keyword in item.title %}
                                            <div class="flex-shrink-0 h-6">
                                                <a href="{{ item.url }}" target="_blank" class="text-sm text-gray-600 hover:text-blue-600 truncate block">
                                                    {{ item.title }}
                                                </a>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ïã§ÏãúÍ∞Ñ Îû≠ÌÇπ ÏÑπÏÖò -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Ïã§ÏãúÍ∞Ñ Îû≠ÌÇπ</h1>
            </div>
            
            {% regroup news_items by company_name as news_by_company %}
            
            <div class="grid grid-cols-4 gap-3">
                {% for company in news_by_company %}
                <div class="bg-white rounded-lg shadow p-2">
                    <div class="flex items-center gap-3 mb-2 bg-gray-50 -mx-2 -mt-2 p-2">
                        <div class="w-10 h-10 overflow-hidden rounded-full bg-white flex items-center justify-center">
                            <img src="{% static 'images/logos/'|add:company.grouper|add:'.png' %}" 
                                 alt="{{ company.grouper }}"
                                 class="{% if company.grouper in 'ÏÑ∏Í≥ÑÏùºÎ≥¥,Ï§ëÏïôÏùºÎ≥¥,ÌïúÍ≤®Î†à,ÌïúÍµ≠ÏùºÎ≥¥' %}w-16 h-16{% else %}w-8 h-8{% endif %} object-contain"
                            />
                        </div>
                        <h2 class="text-base font-bold">{{ company.grouper }}</h2>
                    </div>
                    <div class="space-y-2.5">
                        {% for item in company.list %}
                        <div class="flex gap-2.5">
                            <span class="text-sm font-bold {% if item.rank <= 3 %}text-blue-500{% else %}text-gray-300{% endif %} 
                                   w-4 flex-shrink-0 text-center">{{ item.rank }}</span>
                            <a href="{{ item.url }}" target="_blank" 
                               class="text-sm hover:text-blue-600 leading-5 line-clamp-2 
                                      {% if item.rank <= 3 %}text-gray-900{% else %}text-gray-600{% endif %}">
                                {{ item.title }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<script>
// 5Î∂Ñ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌÉÄÏù¥Î®∏
function startCountdown() {
    let timeLeft = 900; // 5Î∂Ñ(300)ÏóêÏÑú 15Î∂Ñ(900)ÏúºÎ°ú ÏàòÏ†ï
    
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        document.getElementById('countdown').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            location.reload();
        } else {
            timeLeft--;
        }
    }
    
    updateTimer();
    setInterval(updateTimer, 1000);
}

startCountdown();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function initSlider(index) {
        var slider = document.getElementById('keywordSlider' + index);
        if (!slider) {
            return;
        }
        
        var slides = slider.children;
        if (slides.length <= 1) {
            return;
        }
        
        var currentSlide = 0;
        
        setInterval(function() {
            currentSlide = (currentSlide + 1) % slides.length;
            slider.style.transform = 'translateY(-' + (currentSlide * 24) + 'px)';
        }, 5000);
    }

    var keywordCount = "{{ keyword_rankings|length }}";
    keywordCount = parseInt(keywordCount, 10);
    
    for (var i = 1; i <= keywordCount; i++) {
        initSlider(i);
    }
});
</script>

<!-- ÌïÑÌÑ∞ÎßÅ JavaScript Ï∂îÍ∞Ä -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companyFilter = document.getElementById('companyFilter');
    const keywordFilter = document.getElementById('keywordFilter');
    const filteredArticles = document.getElementById('filteredArticles');
    const filteredCount = document.getElementById('filteredCount');

    function filterArticles() {
        const selectedCompany = companyFilter.value;
        const selectedKeyword = keywordFilter.value;
        
        // Ïñ∏Î°†ÏÇ¨Î≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨ ÏÑπÏÖòÏóêÏÑú Í∏∞ÏÇ¨Îì§ÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§
        const articles = Array.from(document.querySelectorAll('.article-item'));
        const filtered = articles.filter(article => {
            const company = article.closest('[data-company]')?.dataset.company;
            const title = article.dataset.keyword;
            
            const matchCompany = selectedCompany === 'all' || company === selectedCompany;
            const matchKeyword = selectedKeyword === 'all' || (title && title.includes(selectedKeyword));
            
            return matchCompany && matchKeyword;
        });

        // ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥ºÎ•º ÌëúÏãú
        filteredArticles.innerHTML = filtered.map(article => {
            const company = article.closest('[data-company]')?.dataset.company;
            const link = article.querySelector('a');
            return `
                <div class="bg-white rounded-lg shadow p-2">
                    <div class="flex flex-col gap-1">
                        <span class="text-base font-bold text-blue-600">${company}</span>
                        <a href="${link.href}" target="_blank" 
                           class="text-sm hover:text-blue-600">
                            ${link.textContent}
                        </a>
                    </div>
                </div>
            `;
        }).join('');

        // ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥º Ïàò ÏóÖÎç∞Ïù¥Ìä∏
        filteredCount.textContent = `(${filtered.length}Í±¥)`;
    }

    // ÌïÑÌÑ∞ Î≥ÄÍ≤Ω Ïãú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
    companyFilter.addEventListener('change', filterArticles);
    keywordFilter.addEventListener('change', filterArticles);

    // Ï¥àÍ∏∞ Î°úÎìúÏãú Ï†ÑÏ≤¥ Í∏∞ÏÇ¨ ÌëúÏãú
    filterArticles();
});
</script>

<script>
document.getElementById('searchBtn').addEventListener('click', function() {
    const company = document.getElementById('companyFilter').value;
    const keyword = document.getElementById('keywordFilter').value;
    
    // ÏÑ†ÌÉùÎêú ÌïÑÌÑ∞Ïóê Îî∞Îùº Í∏∞ÏÇ¨ ÌïÑÌÑ∞ÎßÅ
    const companyCards = document.querySelectorAll('.company-card');
    companyCards.forEach(card => {
        const showByCompany = company === 'all' || card.dataset.company === company;
        const keywordItems = card.querySelectorAll('.keyword-item');
        
        let showByKeyword = keyword === 'all';
        if (!showByKeyword) {
            keywordItems.forEach(item => {
                if (item.dataset.keyword === keyword) {
                    showByKeyword = true;
                }
            });
        }
        
        card.style.display = (showByCompany && showByKeyword) ? 'block' : 'none';
    });
});
</script>
{% endblock %} 

{% block extra_js %}
{% load static %}
<script src="{% static 'js/timer.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        startCountdown();
    });
</script>
{% endblock %} 