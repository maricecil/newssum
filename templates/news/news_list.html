{% extends 'base.html' %}
{% load static %}
{% load news_filters %}

{% block content %}
<div class="w-full px-2">
    <!-- ÏÉàÎ°úÍ≥†Ïπ® ÏÑπÏÖò -->
    <div class="flex justify-end mb-2">
        <div class="flex items-center gap-2">
            <span id="countdown">05:00</span>  <!-- ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ -->
            <button onclick="location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">
                ÏÉàÎ°úÍ≥†Ïπ®
            </button>
        </div>
    </div>

    {% if request.resolver_match.url_name == 'top_articles' %}
        <div class="w-full">
            <!-- ÏÉÅÎã® 2Îã® Í∑∏Î¶¨Îìú ÏÑπÏÖò -->
            <div class="grid grid-cols-2 gap-8">
                <!-- ÏôºÏ™Ω: ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º ÏÑπÏÖò -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        Ï£ºÏöî Í∏∞ÏÇ¨ ÌïÑÌÑ∞ÎßÅ
                        <span class="text-gray-500" id="filteredCount"></span>
                    </h1>
                    <div class="bg-white rounded-lg shadow p-4">
                        <!-- ÌïÑÌÑ∞ Ïª®Ìä∏Î°§ ÏÑπÏÖò -->
                        <div class="flex gap-4 mb-4">
                            <!-- Ïñ∏Î°†ÏÇ¨ ÏÑ†ÌÉù ÌïÑÌÑ∞ -->
                            <div class="relative w-64">
                                <select id="companyFilter" 
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                    <option value="" selected class="text-gray-500 bg-gray-50">Ïñ∏Î°†ÏÇ¨ ÏÑ†ÌÉù</option>
                                    {% for company, articles in news_by_company.items %}
                                        <option value="{{ company }}" class="text-gray-700 hover:bg-gray-100">
                                            {{ company }} ({{ articles|length }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <!-- ÏÑ†ÌÉùÎêú Ïñ∏Î°†ÏÇ¨ ÌÉúÍ∑∏Îì§Ïù¥ ÌëúÏãúÎê† Ïª®ÌÖåÏù¥ÎÑà -->
                                <div id="selectedCompanies" class="flex flex-wrap gap-2 mt-2">
                                    <!-- ÏÑ†ÌÉùÎêú Ïñ∏Î°†ÏÇ¨ ÌÉúÍ∑∏Í∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                                </div>
                            </div>

                            <!-- ÌÇ§ÏõåÎìú ÏÑ†ÌÉù ÌïÑÌÑ∞ -->
                            <div class="relative w-64">
                                <select id="keywordFilter" 
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                    <option value="" selected class="text-gray-500 bg-gray-50">ÌÇ§ÏõåÎìú ÏÑ†ÌÉù</option>
                                    {% for keyword, articles in keyword_articles.items %}
                                        <option value="{{ keyword }}" class="text-gray-700 hover:bg-gray-100">
                                            {{ keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <!-- ÏÑ†ÌÉùÎêú ÌÇ§ÏõåÎìú ÌÉúÍ∑∏Îì§Ïù¥ ÌëúÏãúÎê† Ïª®ÌÖåÏù¥ÎÑà -->
                                <div id="selectedKeywords" class="flex flex-wrap gap-2 mt-2">
                                    <!-- ÏÑ†ÌÉùÎêú ÌÇ§ÏõåÎìú ÌÉúÍ∑∏Í∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                                </div>
                            </div>

                            <!-- ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Î≤ÑÌäº -->
                            <button id="resetFilters" 
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                            </button>
                        </div>
                        <!-- ÌïÑÌÑ∞ÎßÅÎêú Í∏∞ÏÇ¨Îì§Ïù¥ ÌëúÏãúÎê† Ïª®ÌÖåÏù¥ÎÑà -->
                        <div id="filteredArticles" class="space-y-2">
                            <!-- ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥ºÍ∞Ä ÎèôÏ†ÅÏúºÎ°ú ÌëúÏãúÎê® -->
                        </div>
                    </div>
                </div>

                <!-- AI Î∂ÑÏÑù Í≤∞Í≥º ÏÑπÏÖò (Ïò§Î•∏Ï™Ω) -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">AI Ìä∏Î†åÎìú Î∂ÑÏÑù</h1>
                    <div class="bg-white rounded-lg shadow p-4">
                        {% if llm_analysis %}
                            <div class="prose max-w-none space-y-4">
                                <!-- Ï£ºÏöî Ìä∏Î†åÎìú ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-blue-600">
                                        <span class="mr-2">üîç</span>Ï£ºÏöî Ìä∏Î†åÎìú
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.trends|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>

                                <!-- ÌÇ§ÏõåÎìú Ïó∞Í¥ÄÏÑ± ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-green-600">
                                        <span class="mr-2">üîó</span>ÌÇ§ÏõåÎìú Ïó∞Í¥ÄÏÑ±
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.relations|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>

                                <!-- ÌäπÏù¥ÏÇ¨Ìï≠ ÏÑπÏÖò -->
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center text-purple-600">
                                        <span class="mr-2">üí°</span>ÌäπÏù¥ÏÇ¨Ìï≠
                                    </h3>
                                    <p class="text-gray-700 ml-6">{{ llm_analysis.insights|default:"Î∂ÑÏÑù Ï§ÄÎπÑÏ§ë..." }}</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-gray-500 text-center py-4">
                                <p>Î∂ÑÏÑù Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ÌïòÎã®Ïùò Í∏∞Ï°¥ ÏÑπÏÖòÎì§ -->
            <div class="grid grid-cols-2 gap-8 mt-8">
                <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨ ÏÑπÏÖò -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        Ïñ∏Î°†ÏÇ¨Î≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨
                        <span class="text-gray-500">({{ article_count }}Í±¥)</span>
                    </h1>
                    
                    {% if news_by_company %}
                        <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Í∏∞ÏÇ¨ ÌëúÏãú (Í∞ÑÍ≤© Ï∂ïÏÜå) -->
                        <div class="space-y-2">  <!-- space-y-4ÏóêÏÑú space-y-2Î°ú Î≥ÄÍ≤Ω: Í∏∞ÏÇ¨ Í∞ÑÍ≤© Ï∂ïÏÜå -->
                            {% for company, articles in news_by_company.items %}
                            <div class="bg-white rounded-lg shadow p-2" data-company="{{ company }}">  <!-- data-company: ÌïÑÌÑ∞ÎßÅÏö© ÏÜçÏÑ± -->
                                <div class="flex items-center gap-1 mb-2 pb-1 border-b">  <!-- Ïñ∏Î°†ÏÇ¨ Ìó§Îçî -->
                                    <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                                    <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                                </div>
                                <div class="space-y-1.5">  <!-- Í∏∞ÏÇ¨ Î™©Î°ù Ïª®ÌÖåÏù¥ÎÑà -->
                                    {% for article in articles %}
                                    <div class="flex gap-1.5 article-item" data-keyword="{{ article.title }}">  <!-- article-item: ÌïÑÌÑ∞ÎßÅÏö© ÌÅ¥ÎûòÏä§ -->
                                        <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">
                                            {{ article.rank }}
                                        </span>
                                        <a href="{{ article.url }}" target="_blank" 
                                           class="text-sm hover:text-blue-600 flex-1">
                                            {{ article.title }}
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Í∏∞Ï°¥ Í∏∞ÏÇ¨ Î™©Î°ù ÌëúÏãú Ïú†ÏßÄ (news_by_companyÍ∞Ä ÏóÜÏùÑ ÎïåÏùò ÎåÄÏ≤¥ ÌëúÏãú) -->
                        <div class="space-y-4">
                            {% for article in articles %}
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="flex flex-col gap-2">
                                    <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                                    <a href="{{ article.url }}" target="_blank" 
                                       class="text-lg hover:text-blue-600">
                                        {{ article.title }}
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-gray-500 text-center py-8">Í¥ÄÎ†® Í∏∞ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- ÌÇ§ÏõåÎìúÎ≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨ ÏÑπÏÖò -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        ÌÇ§ÏõåÎìúÎ≥Ñ Ï£ºÏöî Í∏∞ÏÇ¨
                        <span class="text-gray-500">({{ total_keyword_articles }}Í±¥)</span>
                    </h1>
                    
                    <div class="space-y-2">
                        {% for keyword, articles in keyword_articles.items %}
                        <div class="bg-white rounded-lg shadow p-3">
                            <div class="flex items-center gap-2 mb-2 pb-2 border-b whitespace-nowrap">  <!-- whitespace-nowrap: ÌÇ§ÏõåÎìú Ï§ÑÎ∞îÍøà Î∞©ÏßÄ -->
                                <span class="text-lg font-bold text-blue-600 flex-shrink-0">"{{ keyword }}" Í¥ÄÎ†®</span>  <!-- flex-shrink-0: ÌÇ§ÏõåÎìú Ï∂ïÏÜå Î∞©ÏßÄ -->
                                <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                            </div>
                            <div class="space-y-2">
                                {% for article in articles %}
                                <div class="flex gap-2 whitespace-nowrap overflow-hidden">  <!-- Í∏∞ÏÇ¨ Ï†úÎ™© Ìïú Ï§Ñ ÌëúÏãú ÏÑ§Ï†ï -->
                                    <span class="text-sm text-gray-400 flex-shrink-0">{{ article.company_name }}</span>
                                    <a href="{{ article.url }}" target="_blank" 
                                       class="text-sm hover:text-blue-600 truncate">  <!-- truncate: Í∏¥ Ï†úÎ™© ÎßêÏ§ÑÏûÑ Ï≤òÎ¶¨ -->
                                        {{ article.title }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% elif keyword %}
        <!-- ÌÇ§ÏõåÎìú Í≤ÄÏÉâ Í≤∞Í≥º ÏÑπÏÖò -->
        <div class="mb-6 max-w-3xl ml-8">
            <h1 class="text-2xl font-bold mb-4">
                "{{ keyword }}" Í¥ÄÎ†® Í∏∞ÏÇ¨
                <span class="text-gray-500">({{ article_count }}Í±¥)</span>
            </h1>
            
            {% if news_by_company %}
                <!-- Ïñ∏Î°†ÏÇ¨Î≥Ñ Í∏∞ÏÇ¨ ÌëúÏãú (Í∞ÑÍ≤© Ï∂ïÏÜå) -->
                <div class="space-y-2">  <!-- space-y-4ÏóêÏÑú space-y-2Î°ú Î≥ÄÍ≤Ω: Í∏∞ÏÇ¨ Í∞ÑÍ≤© Ï∂ïÏÜå -->
                    {% for company, articles in news_by_company.items %}
                    <div class="bg-white rounded-lg shadow p-2">  <!-- p-3ÏóêÏÑú p-2Î°ú Î≥ÄÍ≤Ω: Ìå®Îî© Ï∂ïÏÜå -->
                        <div class="flex items-center gap-1 mb-2 pb-1 border-b">  <!-- gap-2‚Üígap-1, pb-2‚Üípb-1: Í∞ÑÍ≤© Ï∂ïÏÜå -->
                            <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                            <span class="text-sm text-gray-500">({{ articles|length }}Í±¥)</span>
                        </div>
                        <div class="space-y-1.5">  <!-- space-y-2ÏóêÏÑú space-y-1.5Î°ú Î≥ÄÍ≤Ω: Í∏∞ÏÇ¨ Í∞ÑÍ≤© ÎØ∏ÏÑ∏ Ï°∞Ï†ï -->
                            {% for article in articles %}
                            <div class="flex gap-1.5">  <!-- gap-2ÏóêÏÑú gap-1.5Î°ú Î≥ÄÍ≤Ω: ÏöîÏÜå Í∞ÑÍ≤© ÎØ∏ÏÑ∏ Ï°∞Ï†ï -->
                                <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">  <!-- w-5ÏóêÏÑú w-4Î°ú Î≥ÄÍ≤Ω: ÏàúÏúÑ ÎÑàÎπÑ Ï∂ïÏÜå -->
                                    {{ article.rank }}
                                </span>
                                <a href="{{ article.url }}" target="_blank" 
                                   class="text-sm hover:text-blue-600 flex-1">
                                    {{ article.title }}
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Í∏∞Ï°¥ Í∏∞ÏÇ¨ Î™©Î°ù ÌëúÏãú Ïú†ÏßÄ -->
                <div class="space-y-4">
                    {% for article in articles %}
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                            <a href="{{ article.url }}" target="_blank" 
                               class="text-lg hover:text-blue-600">
                                {{ article.title }}
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-8">Í¥ÄÎ†® Í∏∞ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

    {% else %}
        <!-- Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§ Îû≠ÌÇπ (Î©îÏù∏) -->
        <div class="mb-3">
            <div class="flex justify-between gap-8">
                <!-- Ïã§ÏãúÍ∞Ñ Ï£ºÏöî Îâ¥Ïä§ ÏÑπÏÖò -->
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <h1 class="text-xl font-bold">Ïã§ÏãúÍ∞Ñ Ï£ºÏöî Îâ¥Ïä§</h1>
                        <span class="text-sm text-gray-500">
                            ({{ last_update|date:'Y.m.d H:i' }} Í∏∞Ï§Ä)
                        </span>
                    </div>
                    <div class="grid gap-1">
                        {% for item in daily_rankings %}
                        <div class="bg-white rounded shadow-sm p-2">
                            <div class="flex flex-col gap-1">
                                <span class="text-base font-bold text-blue-600">{{ item.company_name }}</span>
                                <a href="{{ item.url }}" target="_blank" class="text-base hover:text-blue-600">{{ item.title }}</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Ï£ºÏöî ÌÇ§ÏõåÎìú ÏÑπÏÖò -->
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2">
                        <h1 class="text-xl font-bold">Ï§ëÏöî ÌÇ§ÏõåÎìú</h1>
                    </div>
                    <div class="grid gap-1">
                        {% for keyword, count, keyword_group in keyword_rankings %}
                        <div class="bg-white rounded shadow-sm p-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 w-32">
                                    <span class="text-base font-bold w-4">{{ forloop.counter }}</span>
                                    <a href="{% url 'news:keyword_articles' keyword=keyword %}" 
                                       class="text-blue-600 hover:text-blue-800 text-base font-medium 
                                              transition-colors flex items-center gap-1 whitespace-nowrap">
                                        {{ keyword }}
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </a>
                                </div>
                                <!-- Ïä¨ÎùºÏù¥Îçî Ïª®ÌÖåÏù¥ÎÑà ÏàòÏ†ï: Í∞ÑÍ≤© Ï§ÑÏù¥Í≥† ÎÑàÎπÑ ÌôïÏû• -->
                                <div class="relative w-[36rem] ml-1 overflow-hidden h-6">
                                    <div id="keywordSlider{{ forloop.counter }}" class="flex flex-col transition-transform duration-500">
                                        {% for item in news_items %}
                                            {% if keyword in item.title %}
                                            <div class="flex-shrink-0 h-6">
                                                <a href="{{ item.url }}" target="_blank" class="text-sm text-gray-600 hover:text-blue-600 truncate block">
                                                    {{ item.title }}
                                                </a>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ïã§ÏãúÍ∞Ñ Îû≠ÌÇπ ÏÑπÏÖò -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Ïã§ÏãúÍ∞Ñ Îû≠ÌÇπ</h1>
            </div>
            
            {% regroup news_items by company_name as news_by_company %}
            
            <div class="grid grid-cols-4 gap-3">
                {% for company in news_by_company %}
                <div class="bg-white rounded-lg shadow p-2">
                    <div class="flex items-center gap-3 mb-2 bg-gray-50 -mx-2 -mt-2 p-2">
                        <div class="w-10 h-10 overflow-hidden rounded-full bg-white flex items-center justify-center">
                            <img src="{% static 'images/logos/'|add:company.grouper|add:'.png' %}" 
                                 alt="{{ company.grouper }}"
                                 class="{% if company.grouper in 'ÏÑ∏Í≥ÑÏùºÎ≥¥,Ï§ëÏïôÏùºÎ≥¥,ÌïúÍ≤®Î†à,ÌïúÍµ≠ÏùºÎ≥¥' %}w-16 h-16{% else %}w-8 h-8{% endif %} object-contain"
                            />
                        </div>
                        <h2 class="text-base font-bold">{{ company.grouper }}</h2>
                    </div>
                    <div class="space-y-2.5">
                        {% for item in company.list %}
                        <div class="flex gap-2.5">
                            <span class="text-sm font-bold {% if item.rank <= 3 %}text-blue-500{% else %}text-gray-300{% endif %} 
                                   w-4 flex-shrink-0 text-center">{{ item.rank }}</span>
                            <a href="{{ item.url }}" target="_blank" 
                               class="text-sm hover:text-blue-600 leading-5 line-clamp-2 
                                      {% if item.rank <= 3 %}text-gray-900{% else %}text-gray-600{% endif %}">
                                {{ item.title }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<script>
// 15Î∂Ñ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌÉÄÏù¥Î®∏ Íµ¨ÌòÑ
function startCountdown() {
    let timeLeft = 900; // 15Î∂Ñ = 900Ï¥à
    
    // Îß§ Ï¥àÎßàÎã§ ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        // ÌÉÄÏù¥Î®∏ ÌëúÏãú ÌòïÏãù: MM:SS
        document.getElementById('countdown').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // ÏãúÍ∞ÑÏù¥ Îã§ ÎêòÎ©¥ ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
        if (timeLeft <= 0) {
            location.reload();
        } else {
            timeLeft--;
        }
    }
    
    // Ï¥àÍ∏∞ ÌÉÄÏù¥Î®∏ ÌëúÏãú Î∞è 1Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    updateTimer();
    setInterval(updateTimer, 1000);
}

startCountdown();
</script>

<!-- ÌïÑÌÑ∞ÎßÅ Í∏∞Îä• Íµ¨ÌòÑ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script>
// Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏ Ïú†ÏßÄ
let selectedCompanyList = new Set();
let selectedKeywordList = new Set();
let companyFilter, keywordFilter, selectedCompanies, selectedKeywords;

// DOM Ï¥àÍ∏∞Ìôî Î∞è Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà - window.onloadÎ°ú Î≥ÄÍ≤Ω
window.onload = function() {
    // DOM ÏöîÏÜå Ï¥àÍ∏∞Ìôî Ïãú null Ï≤¥ÌÅ¨
    companyFilter = document.getElementById('companyFilter');
    selectedCompanies = document.getElementById('selectedCompanies');
    const filteredContainer = document.getElementById('filteredArticles');
    
    // ÌïÑÏàò ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî Ï§ëÎã®
    if (!companyFilter || !selectedCompanies || !filteredContainer) {
        console.warn('ÌïÑÏàò DOM ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
    }

    // Ïñ∏Î°†ÏÇ¨ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ - Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ
    if (companyFilter) {
        companyFilter.addEventListener('change', function(e) {
            const option = e.target.options[e.target.selectedIndex];
            if (option.value === "") return;
            
            // ÏÑ†ÌÉù Ï†úÌïú Ï°∞Í±¥: ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•
            if (selectedCompanyList.size >= 3 && !selectedCompanyList.has(option.value)) {
                alert('ÏµúÎåÄ 3Í∞úÏùò Ïñ∏Î°†ÏÇ¨Îßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                option.selected = false;  // ÏÑ†ÌÉù Ï∑®ÏÜå
                return;
            }
            
            if (option.selected) {
                selectedCompanyList.add(option.value);
            } else {
                selectedCompanyList.delete(option.value);
            }
            
            updateTags();
            filterArticles();
        });
    }

    // ÏÑ†ÌÉùÏ†Å DOM ÏöîÏÜå Ï¥àÍ∏∞Ìôî - Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ
    keywordFilter = document.getElementById('keywordFilter');
    selectedKeywords = document.getElementById('selectedKeywords');
};

// ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò ÏàòÏ†ï
function updateTags() {
    if (!selectedCompanies) return;  // null Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä
    
    selectedCompanies.innerHTML = '';
    selectedCompanyList.forEach(company => {
        const tag = document.createElement('div');
        tag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm';
        tag.innerHTML = `
            ${company}
            <button class="text-blue-600 hover:text-blue-800" onclick="removeCompany('${company}')">√ó</button>
        `;
        selectedCompanies.appendChild(tag);
    });
}

// ÌïÑÌÑ∞ÎßÅ Î©îÏù∏ Ìï®Ïàò - null Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä
window.filterArticles = function() {
    const selectedCompanies = Array.from(selectedCompanyList);
    const selectedKeywords = Array.from(selectedKeywordList);
    const filteredContainer = document.getElementById('filteredArticles');
    
    if (!filteredContainer) return;
    
    filteredContainer.innerHTML = '';
    
    // ÌÇ§ÏõåÎìúÎßå ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú
    if (selectedKeywords.length > 0 && selectedCompanies.length === 0) {
        filteredContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Ïñ∏Î°†ÏÇ¨Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>';
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = '';
        return;
    }
    
    // ÏïÑÎ¨¥Í≤ÉÎèÑ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
    if (selectedCompanies.length === 0 && selectedKeywords.length === 0) {
        filteredContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Ïñ∏Î°†ÏÇ¨ÏôÄ ÌÇ§ÏõåÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>';
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = '';
        return;
    }
    
    const companyContainers = document.querySelectorAll('div[data-company]');
    let totalArticles = 0;
    
    companyContainers.forEach(container => {
        const company = container.dataset.company;
        if (selectedCompanies.includes(company)) {  // 'all' Ï°∞Í±¥ Ï†úÍ±∞
            const articles = container.querySelectorAll('.article-item');
            articles.forEach(article => {
                const articleTitle = article.textContent.toLowerCase();
                const matchesKeywords = selectedKeywords.length === 0 || 
                    selectedKeywords.some(keyword => articleTitle.includes(keyword.toLowerCase()));
                
                if (matchesKeywords) {
                    const clonedArticle = article.cloneNode(true);
                    const articleWrapper = document.createElement('div');
                    articleWrapper.className = 'flex items-center gap-2 mb-2';
                    
                    const companyName = document.createElement('span');
                    companyName.className = 'text-sm font-bold text-blue-600';
                    companyName.textContent = company;
                    
                    articleWrapper.appendChild(companyName);
                    articleWrapper.appendChild(clonedArticle);
                    filteredContainer.appendChild(articleWrapper);
                    totalArticles++;
                }
            });
        }
    });
    
    document.getElementById('filteredCount').textContent = `(${totalArticles}Í±¥)`;
};

// ÌÉúÍ∑∏ Ï†úÍ±∞ Ìï®Ïàò
window.removeCompany = function(company) {
    selectedCompanyList.delete(company);
    Array.from(companyFilter.options).forEach(option => {
        if (option.value === company) option.selected = false;
    });
    updateTags();
    window.filterArticles();
};

// ÌÇ§ÏõåÎìú ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ï∂îÍ∞Ä
function updateKeywordTags() {
    if (!selectedKeywords) return;
    
    selectedKeywords.innerHTML = '';
    selectedKeywordList.forEach(keyword => {
        const tag = document.createElement('div');
        tag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm';
        tag.innerHTML = `
            ${keyword}
            <button class="text-green-600 hover:text-green-800" onclick="removeKeyword('${keyword}')">√ó</button>
        `;
        selectedKeywords.appendChild(tag);
    });
}

// ÌÇ§ÏõåÎìú Ï†úÍ±∞ Ìï®Ïàò Ï∂îÍ∞Ä
window.removeKeyword = function(keyword) {
    selectedKeywordList.delete(keyword);
    Array.from(keywordFilter.options).forEach(option => {
        if (option.value === keyword) option.selected = false;
    });
    updateKeywordTags();
    filterArticles();
};

// ÌÇ§ÏõåÎìú Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ÏàòÏ†ï
function handleKeywordChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    if (option.value === "") return;
    
    // ÏÑ†ÌÉù Ï†úÌïú Ï°∞Í±¥: ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•
    if (selectedKeywordList.size >= 3 && !selectedKeywordList.has(option.value)) {
        alert('ÏµúÎåÄ 3Í∞úÏùò ÌÇ§ÏõåÎìúÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
        option.selected = false;
        return;
    }
    
    if (option.selected) {
        selectedKeywordList.add(option.value);
    } else {
        selectedKeywordList.delete(option.value);
    }
    
    updateKeywordTags();
    filterArticles();
}
</script>

<script>
// Î™®Îì† Ï¥àÍ∏∞Ìôî Î°úÏßÅÏùÑ ÌïòÎÇòÏùò DOMContentLoaded Ïù¥Î≤§Ìä∏ÏóêÏÑú Ï≤òÎ¶¨
document.addEventListener('DOMContentLoaded', function() {
    // Î™®Îì† ÌïÑÏàò DOM ÏöîÏÜå Ï¥àÍ∏∞Ìôî
    companyFilter = document.getElementById('companyFilter');
    keywordFilter = document.getElementById('keywordFilter');
    const resetButton = document.getElementById('resetFilters');  // Î≥ÄÏàòÎ™Ö Î≥ÄÍ≤Ω
    const searchBtn = document.getElementById('searchBtn');
    
    // Í∞Å ÏöîÏÜåÎ≥Ñ null Ï≤¥ÌÅ¨ ÌõÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
    if (keywordFilter) {
        keywordFilter.addEventListener('change', handleKeywordChange);
    }
    
    if (resetButton) {  // Î≥ÄÏàòÎ™Ö Î≥ÄÍ≤Ω
        resetButton.addEventListener('click', function() {  // ÏùµÎ™Ö Ìï®ÏàòÎ°ú Î≥ÄÍ≤Ω
            // Ïñ∏Î°†ÏÇ¨ ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
            selectedCompanyList.clear();
            Array.from(companyFilter.options).forEach(option => {
                option.selected = false;
            });
            
            // ÌÇ§ÏõåÎìú ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Ï∂îÍ∞Ä
            selectedKeywordList.clear();
            if (keywordFilter) {
                Array.from(keywordFilter.options).forEach(option => {
                    option.selected = false;
                });
            }
            
            // ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateTags();
            updateKeywordTags();  // ÌÇ§ÏõåÎìú ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ Ï∂îÍ∞Ä
            
            // ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ
            window.filterArticles();
        });
    }
    
    if (searchBtn) {
        searchBtn.addEventListener('click', handleSearch);
    }

    // Ï¥àÍ∏∞ ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ
    window.filterArticles();
});

// Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ìï®ÏàòÎì§
function handleCompanyChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    // ... Í∏∞Ï°¥ company change Ìï∏Îì§Îü¨ Î°úÏßÅ ...
}

function handleKeywordChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    if (option.value === "") return;
    
    // ÏÑ†ÌÉù Ï†úÌïú Ï°∞Í±¥: ÏµúÎåÄ 5Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•
    if (selectedKeywordList.size >= 5 && !selectedKeywordList.has(option.value)) {
        alert('ÏµúÎåÄ 5Í∞úÏùò ÌÇ§ÏõåÎìúÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
        option.selected = false;
        return;
    }
    
    if (option.selected) {
        selectedKeywordList.add(option.value);
    } else {
        selectedKeywordList.delete(option.value);
    }
    
    updateKeywordTags();
    filterArticles();
}

function handleSearch() {
    const company = companyFilter.value;
    const keyword = keywordFilter.value;
    // ... Í∏∞Ï°¥ Í≤ÄÏÉâ Î≤ÑÌäº Î°úÏßÅ ...
}
</script>
{% endblock content %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/timer.js' %}"></script>
<script>

</script>
{% endblock extra_js %}