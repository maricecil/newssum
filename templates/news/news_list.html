{% extends 'base.html' %}
{% load static %}
{% load news_filters %}

{% block content %}
{% csrf_token %}
<div class="w-full px-2">
    {% if request.resolver_match.url_name == 'top_articles' %}
        <!-- 기존 top_articles 섹션 전체 -->
        <div class="w-full">
            <!-- 필터링 결과 섹션 -->
            <div class="flex gap-8">
                <!-- 기존 필터 컨트롤 섹션 -->
                <div class="w-full mb-8">
                    <h1 class="text-2xl font-bold mb-4">
                        주요 기사 분석
                        <span class="text-gray-500" id="filteredCount"></span>
                    </h1>
                    <div class="bg-white rounded-lg shadow p-4">
                        <!-- 필터 컨트롤 섹션 -->
                        <div class="flex flex-col gap-4 mb-4">
                            <div class="flex flex-col gap-4">
                                <div class="relative w-full">
                                    <select id="companyFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        <option value="" selected class="text-gray-500 bg-gray-50">언론사 선택</option>
                                        {% for company, articles in news_by_company.items %}
                                            <option value="{{ company }}" class="text-gray-700 hover:bg-gray-100">
                                                {{ company }} ({{ articles|length }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div id="selectedCompanies" class="flex flex-wrap gap-2 mt-2">
                                        <!-- 선택된 언론사 태그들 -->
                                    </div>
                                </div>

                                <div class="relative w-full">
                                    <select id="keywordFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        <option value="" selected class="text-gray-500 bg-gray-50">키워드 선택</option>
                                        {% for keyword, articles in keyword_articles.items %}
                                            <option value="{{ keyword }}" class="text-gray-700 hover:bg-gray-100">
                                                {{ keyword }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div id="selectedKeywords" class="flex flex-wrap gap-2 mt-2">
                                        <!-- 선택된 키워드 태그들 -->
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button id="resetFilters" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                        필터 초기화
                                    </button>
                                    <button id="analyzeBtn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <!-- Spinner SVG -->
                                        <svg id="analyzeSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        분석하기
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 필터링된 기사 목록 -->
                        <div id="filteredArticles" class="mt-4">
                            <!-- 기사 목록 -->
                        </div>

                        <!-- 분석 결과 영역 -->
                        <div id="analysisResults" class="bg-gray-50 rounded-lg p-4 min-h-[200px] hidden mb-4">
                            <div class="space-y-4">
                                <!-- 전체 통계 -->
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">전체 통계</h3>
                                    
                                    <!-- 기본 통계만 표시 -->
                                    <div class="mb-4">
                                        <span>분석 기사: <span id="totalArticles" class="font-medium">0</span>건</span>
                                        <span class="mx-2">|</span>
                                        <span>언론사: <span id="totalPress" class="font-medium">0</span>개</span>
                                        <span class="mx-2">|</span>
                                        <span>키워드: <span id="totalKeywords" class="font-medium">0</span>개</span>
                                    </div>
                                </div>
                                <!-- 분석 결과만 표시하고 하단의 중복 정보는 제거 -->
                                <div class="space-y-4">
                                    <!-- 트렌드 분석 -->
                                    <div class="bg-white rounded p-3 shadow-sm">
                                        <h3 class="text-sm font-medium text-gray-700 mb-2">트렌드 분석</h3>
                                        <div class="space-y-2">
                                            <p id="trendAnalysis" class="text-sm text-gray-600"></p>
                                            <div id="topKeywords" class="flex flex-wrap gap-2 mt-2"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- 관계 분석 -->
                                    <div class="bg-white rounded p-3 shadow-sm">
                                        <h3 class="text-sm font-medium text-gray-700 mb-2">관계 분석</h3>
                                        <div class="space-y-2">
                                            <p id="relationAnalysis" class="text-sm text-gray-600"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- 주요 인사이트 -->
                                    <div class="bg-white rounded p-3 shadow-sm">
                                        <h3 class="text-sm font-medium text-gray-700 mb-2">주요 인사이트</h3>
                                        <div class="space-y-2">
                                            <p id="insightAnalysis" class="text-sm text-gray-600"></p>
                                            <div id="keywordRelations" class="mt-2 text-sm"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 하단 2단 그리드 섹션 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 언론사별 주요 기사 섹션 -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        언론사별 주요 기사
                        <span class="text-gray-500">({{ article_count }}건)</span>
                    </h1>
                    
                    {% if news_by_company %}
                        <!-- 언론사별 기사 표시 (간격 축소) -->
                        <div class="space-y-2">
                            {% for company, articles in news_by_company.items %}
                            <div class="bg-white rounded-lg shadow p-2" data-company="{{ company }}">
                                <div class="flex items-center gap-1 mb-2 pb-1 border-b">
                                    <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                                    <span class="text-sm text-gray-500">({{ articles|length }}건)</span>
                                </div>
                                <div class="space-y-1.5">
                                    {% for article in articles %}
                                    <div class="flex gap-1.5 article-item" data-keyword="{{ article.title }}">
                                        <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">
                                            {{ article.rank }}
                                        </span>
                                        <a href="{{ article.url }}" target="_blank" 
                                           class="text-sm hover:text-blue-600 flex-1">
                                            {{ article.title }}
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- 기존 기사 목록 표시 유지 -->
                        <div class="space-y-4">
                            {% for article in articles %}
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="flex flex-col gap-2">
                                    <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                                    <a href="{{ article.url }}" target="_blank" 
                                       class="text-lg hover:text-blue-600">
                                        {{ article.title }}
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-gray-500 text-center py-8">관련 기사가 없습니다.</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- 키워드별 주요 기사 섹션 -->
                <div class="w-full">
                    <h1 class="text-2xl font-bold mb-4">
                        키워드별 주요 기사
                        <span class="text-gray-500">({{ total_keyword_articles }}건)</span>
                    </h1>
                    
                    {% with shown_titles="" %}
                        {% for keyword, articles in keyword_articles.items %}
                        <div class="bg-white rounded-lg shadow p-3">
                            <div class="flex items-center gap-2 mb-2 pb-2 border-b whitespace-nowrap">
                                <span class="text-lg font-bold text-blue-600 flex-shrink-0">"{{ keyword }}" 관련</span>
                                <span class="text-sm text-gray-500">({{ articles|length }}건)</span>
                            </div>

                            <div class="space-y-2">
                                {% for article in articles %}
                                    {% is_duplicate article.title shown_titles as is_shown %}
                                    {% if not is_shown %}
                                        <div class="flex gap-2 whitespace-nowrap overflow-hidden">
                                            <span class="text-sm text-gray-400 flex-shrink-0">{{ article.company_name }}</span>
                                            <a href="{{ article.url }}" target="_blank" 
                                               class="text-sm hover:text-blue-600 truncate">
                                                {{ article.title }}
                                            </a>
                                        </div>
                                        {% with shown_titles=shown_titles|add:article.title|add:"|||" %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
    {% elif keyword %}
        <!-- 키워드 검색 결과 섹션 -->
        <div class="mb-6 max-w-3xl ml-8">
            <h1 class="text-2xl font-bold mb-4">
                "{{ keyword }}" 관련 기사
                <span class="text-gray-500">({{ article_count }}건)</span>
            </h1>
            
            {% if news_by_company %}

                <!-- 언론사별 기사 표시 -->
                <div class="space-y-2">
                    {% for company, articles in news_by_company.items %}
                    <div class="bg-white rounded-lg shadow p-2">
                        <div class="flex items-center gap-1 mb-2 pb-1 border-b">
                            <span class="text-lg font-bold text-blue-600">{{ company }}</span>
                            <span class="text-sm text-gray-500">({{ articles|length }}건)</span>
                        </div>
                        <div class="space-y-1.5">
                            {% for article in articles %}
                            <div class="flex gap-1.5">
                                <span class="text-sm font-bold {% if article.rank <= 3 %}text-blue-500{% else %}text-gray-400{% endif %} w-4">
                                    {{ article.rank }}
                                </span>
                                <a href="{{ article.url }}" target="_blank" 
                                   class="text-sm hover:text-blue-600 flex-1">
                                    {{ article.title }}
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- 기존 기사 목록 표시 유지 -->
                <div class="space-y-4">
                    {% for article in articles %}
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-base font-bold text-blue-600">{{ article.company_name }}</span>
                            <a href="{{ article.url }}" target="_blank" 
                               class="text-lg hover:text-blue-600">
                                {{ article.title }}
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-8">관련 기사가 없습니다.</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% else %}
        <style>
        @media (max-width: 768px) {
            /* 모바일에서만 적용되는 스타일 */
            .news-layout > div {
                display: flex;
                flex-direction: column;
            }
            
            .news-layout > div > div:nth-child(2) {
                order: -1;  /* 실시간 뉴스를 위로 */
                margin-bottom: 1.5rem;
            }
        }
        </style>

        <div class="mb-3 news-layout">
            <div class="flex gap-6">
                <!-- 실시간 주요 뉴스 섹션 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center gap-2 mb-4">
                        <h2 class="text-lg font-bold">실시간 주요 뉴스</h2>
                        <span class="text-sm text-gray-500">
                            ({{ crawled_time|date:"Y-m-d H:i" }} 기준)
                        </span>
                    </div>

                    {% regroup daily_rankings by company_name as news_by_company %}
                    <!-- 언론사 목록 -->
                    <div class="border-b mb-4">
                        <div class="flex flex-wrap gap-2 px-2 py-1 overflow-x-auto scrollbar-hide">
                            {% for company in news_by_company %}
                                <button 
                                    class="px-3 py-1.5 rounded-full transition-all duration-200 ease-in-out
                                           {% if forloop.first %}
                                               bg-blue-100 text-blue-600 font-medium hover:bg-blue-200
                                           {% else %}
                                               bg-gray-100 text-gray-600 hover:bg-gray-200
                                           {% endif %}
                                           text-sm cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                    data-company-id="{{ company.grouper }}"
                                    onclick="showCompanyNews('{{ company.grouper }}')"
                                    aria-label="{{ company.grouper }} 뉴스 보기">
                                    {{ company.grouper }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- 뉴스 내용 -->
                    {% for company in news_by_company %}
                        <div class="company-news" id="news-{{ company.grouper }}" {% if not forloop.first %}style="display: none;"{% endif %}>
                            {% for item in company.list %}
                                <div class="flex gap-4 {% if not forloop.last %}mb-4 pb-4 border-b{% endif %}">
                                    {% if item.image_url %}
                                        <div class="w-[336px] h-[224px] shrink-0 bg-gray-100 rounded overflow-hidden">
                                            <img src="{{ item.image_url }}" 
                                                 alt="{{ item.title }}"
                                                 class="w-full h-full object-cover">
                                        </div>
                                    {% endif %}
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="text-sm font-medium text-gray-400">{{ item.rank }}</span>
                                            <a href="{{ item.url }}" target="_blank" 
                                               class="text-base font-medium hover:text-blue-600">
                                                {{ item.title }}
                                            </a>
                                        </div>
                                        {% if item.summary %}
                                            <div class="text-sm text-gray-600">
                                                {{ item.summary }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>

                <!-- 키워드 랭킹 섹션 -->
                <div class="w-[32rem]">
                    <div class="flex justify-between items-center mb-2">
                        <h1 class="text-xl font-bold">키워드 랭킹</h1>
                    </div>
                    <div class="grid gap-1">
                        {% for keyword, count, keyword_group in keyword_rankings %}
                        <div class="bg-white rounded shadow-sm p-2">
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1 w-[7rem] shrink-0">
                                    <span class="text-base font-bold w-4">{{ forloop.counter }}</span>
                                    <a href="{% url 'news:keyword_articles' keyword=keyword %}" 
                                       class="text-blue-600 hover:text-blue-800 text-base font-medium transition-colors flex items-center gap-0.5">
                                        {{ keyword }}
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </a>
                                </div>
                                <!-- 슬라이더 컨테이너 -->
                                <div class="relative w-[22rem] overflow-hidden h-6">
                                    <div id="keywordSlider{{ forloop.counter }}" class="flex flex-col transition-all duration-700">
                                        {% with shown_titles="" %}
                                            {% for item in news_items %}
                                                {% if keyword in item.title or keyword in item.related_keywords %}
                                                    {% is_duplicate item.title shown_titles as is_shown %}
                                                    {% if not is_shown %}
                                                        <div class="flex-shrink-0 h-6">
                                                            <a href="{{ item.url }}" target="_blank" 
                                                               class="text-sm text-gray-600 hover:text-blue-600 truncate block">
                                                                {{ item.title }}
                                                            </a>
                                                        </div>
                                                        {% with shown_titles=shown_titles|add:item.title|add:"|||" %}{% endwith %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 실시간 랭킹 섹션 -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">실시간 랭킹</h1>
            </div>
            
            {% regroup news_items by company_name as news_by_company %}
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                {% for company in news_by_company %}
                <div class="bg-white rounded-lg shadow p-2">
                    <div class="flex items-center gap-3 mb-2 bg-gray-50 -mx-2 -mt-2 p-2">
                        <div class="w-10 h-10 overflow-hidden rounded-full bg-white flex items-center justify-center">
                            <img src="{% static 'images/logos/'|add:company.grouper|add:'.png' %}" 
                                 alt="{{ company.grouper }}"
                                 class="{% if company.grouper in '세계일보,중앙일보,한겨레,한국일보' %}w-16 h-16{% else %}w-8 h-8{% endif %} object-contain"
                            />
                        </div>
                        <h2 class="text-base font-bold">{{ company.grouper }}</h2>
                    </div>
                    <div class="space-y-2.5">
                        {% for item in company.list %}
                        <div class="flex gap-2.5">
                            <span class="text-sm font-bold {% if item.rank <= 3 %}text-blue-500{% else %}text-gray-300{% endif %} 
                                   w-4 flex-shrink-0 text-center">{{ item.rank }}</span>
                            <a href="{{ item.url }}" target="_blank" 
                               class="text-sm hover:text-blue-600 leading-5 line-clamp-2 
                                      {% if item.rank <= 3 %}text-gray-900{% else %}text-gray-600{% endif %}">
                                {{ item.title }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<div id="pressDistribution" class="text-sm text-gray-600 mt-2"></div>
<div id="keywordRankings" class="text-sm text-gray-600 mt-2"></div>

<div id="crewAnalysisSpinner" class="hidden">
    <div class="flex justify-center items-center h-40">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
    </div>
</div>

<div id="crewAnalysisContent" class="hidden">
    <!-- 자동 분석 결과가 여기에 표시됩니다 -->
</div>
{% endblock content %}

{% block extra_js %}
<script>
// 1. 전역 변수 초기화
Object.assign(window, {
    isAnalyzing: false,
    selectedCompanyList: new Set(),
    selectedKeywordList: new Set(),
    companyFilter: null,
    keywordFilter: null,
    selectedCompanies: null,
    selectedKeywords: null
});

// DOM 초기화 및 이벤트 리스너
document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOM loaded');
    
    // 페이지 타입 확인
    const isTopArticlesPage = window.location.pathname.includes('/news/top/');
    const hasSliders = document.querySelectorAll('[id^="keywordSlider"]').length > 0;
    
    // 주요 기사 페이지 기능
    if (isTopArticlesPage) {
        // DOM 요소 초기화
        window.elements = {
            companyFilter: document.getElementById('companyFilter'),
            keywordFilter: document.getElementById('keywordFilter'),
            resetButton: document.getElementById('resetFilters'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            analyzeSpinner: document.getElementById('analyzeSpinner'),
            selectedCompanies: document.getElementById('selectedCompanies'),
            selectedKeywords: document.getElementById('selectedKeywords'),
        };

        console.log('elements after init:', elements);

        // 필터링 관련 코드
        if (!elements.companyFilter) {
            console.warn('필터링에 필요한 DOM 요소를 찾을 수 없습니다.');
        } else {
            // 전역 변수에 필요한 요소 할당
            window.companyFilter = elements.companyFilter;
            window.selectedCompanies = elements.selectedCompanies;
            
            if (elements.keywordFilter) {
                window.keywordFilter = elements.keywordFilter;
                window.selectedKeywords = elements.selectedKeywords;
            }

            // 언론사 선택 이벤트
            elements.companyFilter.addEventListener('change', function(e) {
                const option = e.target.options[e.target.selectedIndex];
                if (option.value === "") return;
                
                if (window.selectedCompanyList.size >= 3 && !window.selectedCompanyList.has(option.value)) {
                    alert('최대 3개의 언론사만 선택할 수 있습니다.');
                    option.selected = false;
                    return;
                }
                
                if (option.selected) {
                    window.selectedCompanyList.add(option.value);
                } else {
                    window.selectedCompanyList.delete(option.value);
                }
                
                updateTags();
                filterArticles();
            });

            // 키워드 필터 이벤트
            if (elements.keywordFilter) {
                elements.keywordFilter.addEventListener('change', handleKeywordChange);
            }

            // 리셋 버튼 이벤트
            if (elements.resetButton) {
                elements.resetButton.addEventListener('click', function() {
                    window.selectedCompanyList.clear();
                    window.selectedKeywordList.clear();
                    
                    Array.from(elements.companyFilter.options).forEach(option => {
                        option.selected = false;
                    });
                    
                    if (elements.keywordFilter) {
                        Array.from(elements.keywordFilter.options).forEach(option => {
                            option.selected = false;
                        });
                    }
                    
                    // 분석 결과 초기화 추가
                    const results = document.getElementById('analysisResults');
                    if (results) {
                        results.classList.add('hidden');
                        results.style.display = 'none';
                    }
        
                    // 분석 결과 내용 초기화
                    const sections = ['trendAnalysis', 'relationAnalysis', 'insightAnalysis'];
                    sections.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = '';
                    });
        
                    // 통계 초기화
                    ['totalArticles', 'totalPress', 'totalKeywords'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = '0';
                    });

                    updateTags();
                    updateKeywordTags();
                    window.filterArticles();
                });
            }

            // 분석 버튼 이벤트
            if (elements.analyzeBtn) {
                elements.analyzeBtn.addEventListener('click', async function() {
                    if (window.isAnalyzing) return;

                    try {
                        // 1. 입력 검증 강화
                        if (window.selectedCompanyList.size === 0 && window.selectedKeywordList.size === 0) {
                            alert('분석할 언론사나 키워드를 선택해주세요.');
                            return;
                        }

                        // 2. 상태 관리 개선
                        window.isAnalyzing = true;
                        elements.analyzeBtn.disabled = true;
                        
                        if (elements.analyzeSpinner) {
                            elements.analyzeSpinner.classList.remove('hidden');
                            elements.analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        }

                        // 3. 요청 데이터 구조화
                        const requestData = {
                            companies: Array.from(window.selectedCompanyList),
                            keywords: Array.from(window.selectedKeywordList),
                            timestamp: new Date().toISOString()  // 캐시 충돌 방지
                        };

                        // 4. 에러 처리 개선
                        const response = await fetch('/news/analyze/trends/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        // 5. 응답 상태 코드 처리 개선
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `서버 응답 오류: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        // 6. 성공 처리 개선
                        if (data.success) {
                            const results = document.getElementById('analysisResults');
                            if (!results) {
                                throw new Error('분석 결과를 표시할 요소를 찾을 수 없습니다.');
                            }

                            // 7. UI 업데이트 최적화
                            results.style.display = 'none';  // 변경 전 숨김
                            updateAnalysisResults(data);
                            results.classList.remove('hidden');
                            results.style.display = 'block';
                            
                            // 8. 부드러운 스크롤 처리
                            results.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'start'
                            });
                        } else {
                            throw new Error(data.error || '분석 결과를 가져오는데 실패했습니다.');
                        }

                    } catch (error) {
                        console.error('분석 중 상세 오류:', error);
                        alert(`분석 중 오류가 발생했습니다: ${error.message}`);
                    } finally {
                        // 9. 상태 초기화 보장
                        window.isAnalyzing = false;
                        elements.analyzeBtn.disabled = false;
                        
                        if (elements.analyzeSpinner) {
                            elements.analyzeSpinner.classList.add('hidden');
                            elements.analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                });
            }

            // 초기 필터링 실행
            window.filterArticles();
        }
    }
    
    // 슬라이더 초기화 - 페이지 타입과 관계없이 독립적으로 실행
    if (hasSliders) {
        console.log('슬라이더 초기화 시작');
        const keywordRankings = document.querySelectorAll('[id^="keywordSlider"]');
        console.log('발견된 슬라이더:', keywordRankings.length);

        keywordRankings.forEach((slider, index) => {
            console.log(`슬라이더 ${index + 1} 초기화`);
            initializeSlider(index + 1);
        });
    }
});

// 키워드 슬라이더 함수
function initializeSlider(index) {
    const slider = document.getElementById(`keywordSlider${index}`);
    if (!slider || slider.children.length <= 1) {
        console.log(`슬라이더 ${index}: 초기화 건너뜀 (요소 없음 또는 항목 부족)`);
        return;
    }
    
    console.log(`슬라이더 ${index}: ${slider.children.length}개 항목으로 초기화`);
    let currentPosition = 0;
    
    setInterval(() => {
        currentPosition = (currentPosition + 1) % slider.children.length;
        slider.style.transform = `translateY(-${currentPosition * 24}px)`;
    }, 5000);
}

// 키워드 변경 이벤트 핸들러
function handleKeywordChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    if (option.value === "") return;
    
    if (window.selectedKeywordList.size >= 5 && !window.selectedKeywordList.has(option.value)) {
        alert('최대 5개의 키워드만 선택할 수 있습니다.');
        option.selected = false;
        return;
    }
    
    if (option.selected) {
        window.selectedKeywordList.add(option.value);
    } else {
        window.selectedKeywordList.delete(option.value);
    }
    
    updateKeywordTags();
    filterArticles();
}

// 분석 결과 업데이트 함수
function updateAnalysisResults(data) {
    if (!data?.analysis) {
        console.error('Invalid analysis data:', data);
        return;
    }

    const totalArticles = document.getElementById('totalArticles');
    const totalPress = document.getElementById('totalPress');
    const totalKeywords = document.getElementById('totalKeywords');
    
    if (totalArticles) totalArticles.textContent = data.analysis.filtered_count ?? '0';
    if (totalPress) totalPress.textContent = window.selectedCompanyList.size;
    if (totalKeywords) totalKeywords.textContent = window.selectedKeywordList.size;

    const updateSection = (elementId, content) => {
        const element = document.getElementById(elementId);
        if (element && content) {
            element.textContent = content;
            element.style.whiteSpace = 'pre-line';
        }
    };

    if (data.analysis.llm_analysis) {
        updateSection('trendAnalysis', data.analysis.llm_analysis.trends);
        updateSection('relationAnalysis', data.analysis.llm_analysis.relations);
        updateSection('insightAnalysis', data.analysis.llm_analysis.insights);
    }

    const results = document.getElementById('analysisResults');
    if (results) {
        results.classList.remove('hidden');
        results.style.display = 'block';
    }
}

// 페이지 이탈 시 처리
window.addEventListener('beforeunload', function() {
    if (window.isAnalyzing) {
        window.isAnalyzing = false;
    }
});
</script>

<script>
// 2. 태그 관련 함수들
function updateTags() {
    if (!selectedCompanies) return;
    
    selectedCompanies.innerHTML = '';
    window.selectedCompanyList.forEach(company => {
        const tag = document.createElement('div');
        tag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm';
        tag.innerHTML = `
            ${company}
            <button class="text-blue-600 hover:text-blue-800" onclick="removeCompany('${company}')">×</button>
        `;
        selectedCompanies.appendChild(tag);
    });
}

function updateKeywordTags() {
    if (!selectedKeywords) return;
    
    selectedKeywords.innerHTML = '';
    window.selectedKeywordList.forEach(keyword => {
        const tag = document.createElement('div');
        tag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm';
        tag.innerHTML = `
            ${keyword}
            <button class="text-green-600 hover:text-green-800" onclick="removeKeyword('${keyword}')">×</button>
        `;
        selectedKeywords.appendChild(tag);
    });
}

// 3. 태그 제거 함수들
window.removeCompany = function(company) {
    window.selectedCompanyList.delete(company);
    Array.from(companyFilter.options).forEach(option => {
        if (option.value === company) option.selected = false;
    });
    updateTags();
    window.filterArticles();
};

window.removeKeyword = function(keyword) {
    window.selectedKeywordList.delete(keyword);
    Array.from(keywordFilter.options).forEach(option => {
        if (option.value === keyword) option.selected = false;
    });
    updateKeywordTags();
    window.filterArticles();
};

// 4. 필터링 함수
window.filterArticles = function() {
    const selectedCompanies = Array.from(window.selectedCompanyList);
    const selectedKeywords = Array.from(window.selectedKeywordList);
    const filteredContainer = document.getElementById('filteredArticles');
    
    if (!filteredContainer) return;
    
    filteredContainer.innerHTML = '';
    
    if (selectedKeywords.length > 0 && selectedCompanies.length === 0) {
        filteredContainer.innerHTML = '<p class="text-gray-500 text-center py-4">언론사를 먼저 선택해주세요.</p>';
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = '';
        return;
    }
    
    if (selectedCompanies.length === 0 && selectedKeywords.length === 0) {
        filteredContainer.innerHTML = '<p class="text-gray-500 text-center py-4">언론사와 키워드를 선택해주세요.</p>';
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = '';
        return;
    }

    const companyContainers = document.querySelectorAll('div[data-company]');
    let totalArticles = 0;
    
    companyContainers.forEach(container => {
        const company = container.dataset.company;
        if (selectedCompanies.includes(company)) {
            const articles = container.querySelectorAll('.article-item');
            articles.forEach(article => {
                const articleTitle = article.textContent.toLowerCase();
                const matchesKeywords = selectedKeywords.length === 0 || 
                    selectedKeywords.some(keyword => articleTitle.includes(keyword.toLowerCase()));
                
                if (matchesKeywords) {
                    const clonedArticle = article.cloneNode(true);
                    const articleWrapper = document.createElement('div');
                    articleWrapper.className = 'flex items-center gap-2 mb-2';
                    
                    const companyName = document.createElement('span');
                    companyName.className = 'text-sm font-bold text-blue-600';
                    companyName.textContent = company;
                    
                    articleWrapper.appendChild(companyName);
                    articleWrapper.appendChild(clonedArticle);
                    filteredContainer.appendChild(articleWrapper);
                    totalArticles++;
                }
            });
        }
    });
    
    document.getElementById('filteredCount').textContent = `(${totalArticles}건)`;
};

// 5. 이벤트 핸들러 함수들
function handleCompanyChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    if (option.value === "") return;
    
    if (window.selectedCompanyList.size >= 3 && !window.selectedCompanyList.has(option.value)) {
        alert('최대 3개의 언론사만 선택할 수 있습니다.');
        option.selected = false;
        return;
    }
    
    if (option.selected) {
        window.selectedCompanyList.add(option.value);
    } else {
        window.selectedCompanyList.delete(option.value);
    }
    
    updateTags();
    window.filterArticles();
}

function handleKeywordChange(e) {
    const option = e.target.options[e.target.selectedIndex];
    if (option.value === "") return;
    
    if (window.selectedKeywordList.size >= 5 && !window.selectedKeywordList.has(option.value)) {
        alert('최대 5개의 키워드만 선택할 수 있습니다.');
        option.selected = false;
        return;
    }
    
    if (option.selected) {
        window.selectedKeywordList.add(option.value);
    } else {
        window.selectedKeywordList.delete(option.value);
    }
    
    updateKeywordTags();
    window.filterArticles();
}

// 분석 결과 업데이트 함수 
function updateAnalysisResults(data) {
    // 디버깅
    console.log('Received data:', data);

    if (!data?.analysis) {
        console.error('Invalid analysis data:', data);
        return;
    }

    // 1. 통계 업데이트만 유지
    const totalArticles = document.getElementById('totalArticles');
    const totalPress = document.getElementById('totalPress');
    const totalKeywords = document.getElementById('totalKeywords');
    
    if (totalArticles) totalArticles.textContent = data.analysis.filtered_count ?? '0';
    if (totalPress) totalPress.textContent = window.selectedCompanyList.size;
    if (totalKeywords) totalKeywords.textContent = window.selectedKeywordList.size;

    // 2. GPT 분석 결과 업데이트
    const updateSection = (elementId, content) => {
        const element = document.getElementById(elementId);
        if (element && content) {
            element.textContent = content;
            element.style.whiteSpace = 'pre-line';
        }
    };

    if (data.analysis.llm_analysis) {
        updateSection('trendAnalysis', data.analysis.llm_analysis.trends);
        updateSection('relationAnalysis', data.analysis.llm_analysis.relations);
        updateSection('insightAnalysis', data.analysis.llm_analysis.insights);
    }

    // 3. 결과 영역 표시
    const results = document.getElementById('analysisResults');
    if (results) {
        results.classList.remove('hidden');
        results.style.display = 'block';
    }
}

// 6. 슬라이더 관리자 객체 - 여러 키워드 슬라이더를 통합 관리하는 객체
const SliderManager = {
    // 초기화된 슬라이더들을 저장하는 객체
    sliders: {},
    // 중복된 제목을 필터링하기 위한 Set
    shownTitles: new Set(),
    // 현재 활성화된 슬라이더의 인덱스
    currentSliderIndex: 1,

    // 슬라이더 초기화 메서드
    initialize() {
        // 모든 키워드 슬라이더 요소를 찾아서 순서대로 정렬
        const keywordRankings = Array.from(document.querySelectorAll('[id^="keywordSlider"]'))
            .sort((a, b) => {
                // 슬라이더 ID의 숫자를 기준으로 정렬 (예: keywordSlider1, keywordSlider2, ...)
                const rankA = parseInt(a.id.replace('keywordSlider', ''));
                const rankB = parseInt(b.id.replace('keywordSlider', ''));
                return rankA - rankB;
            });

        // 정렬된 슬라이더들을 초기화
        this.initializeSliders(keywordRankings);
        
        // 초기화된 슬라이더가 있으면 5초마다 로테이션 시작
        if (Object.keys(this.sliders).length > 0) {
            setInterval(() => this.rotateSliders(), 5000);
        }
    },

    // 개별 슬라이더 초기화 메서드
    initializeSliders(keywordRankings) {
        keywordRankings.forEach((slider, index) => {
            const rank = index + 1;
            // 슬라이더가 없거나 항목이 1개 이하면 초기화하지 않음
            if (!slider || slider.children.length <= 1) return;

            // 중복된 제목을 가진 슬라이드 필터링
            const validSlides = Array.from(slider.children).filter(slide => {
                const title = slide.textContent.trim();
                if (this.shownTitles.has(title)) return false;
                this.shownTitles.add(title);
                return true;
            });

            // 유효한 슬라이드가 있으면 슬라이더 객체 생성
            if (validSlides.length > 0) {
                slider.innerHTML = '';
                validSlides.forEach(slide => slider.appendChild(slide));
                
                // 슬라이더 상태 정보 저장
                this.sliders[rank] = {
                    element: slider,
                    currentPosition: 0,
                    maxPosition: validSlides.length - 1
                };
            }
        });
    },

    // 슬라이더 로테이션 메서드
    rotateSliders() {
        // 현재 슬라이더를 초기 위치로 되돌림
        if (this.sliders[this.currentSliderIndex]) {
            this.sliders[this.currentSliderIndex].element.style.transform = 'translateY(0)';
            this.sliders[this.currentSliderIndex].currentPosition = 0;
        }

        // 모든 슬라이더를 순회했으면 초기화
        if (this.currentSliderIndex >= Object.keys(this.sliders).length) {
            this.shownTitles.clear();
            this.currentSliderIndex = 0;
        }

        // 다음 슬라이더로 이동
        this.currentSliderIndex++;

        // 현재 슬라이더가 있고 여러 항목이 있으면 애니메이션 실행
        if (this.sliders[this.currentSliderIndex] && this.sliders[this.currentSliderIndex].maxPosition > 0) {
            const slider = this.sliders[this.currentSliderIndex];
            slider.currentPosition = (slider.currentPosition + 1) % (slider.maxPosition + 1);
            slider.element.style.transform = `translateY(-${slider.currentPosition * 24}px)`;
        }
    }
};

</script>

<style>
@media (max-width: 768px) {
    /* 기존 스타일 유지 */
    .flex.gap-8 {
        flex-direction: column !important
    }
    
    .w-1\/2 {
        width: 100% !important
    }
    
    .grid-cols-4 {
        grid-template-columns: 1fr !important
    }

    /* 실시간 랭킹 언론사 헤더 수정 */
    .flex.items-center.gap-3 {
        display: flex !important;
        align-items: center !important;
        gap: 1.5rem !important;
        padding: 0.5rem !important;
        margin: -0.5rem -0.5rem 0.5rem -0.5rem !important
    }

    .w-10.h-10 {
        width: 2rem !important;
        height: 2rem !important;
        flex-shrink: 0 !important
    }

    .w-8.h-8 {
        width: 1.5rem !important;
        height: 1.5rem !important
    }

    .w-16.h-16 {
        width: 2rem !important;
        height: 2rem !important
    }

    /* 나머지 기존 스타일 유지 */
    .max-w-full {
        max-width: 100vw !important;
        margin-left: calc(-50vw + 50%) !important;
        margin-right: calc(-50vw + 50%) !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important
    }
    
    .bg-white {
        border-radius: 0.5rem !important;
        margin-left: -1rem !important;
        margin-right: -1rem !important;
        width: calc(100% + 2rem) !important
    }
    
    #analysisResults {
        margin-top: 1rem !important;
        margin-left: -1rem !important;
        margin-right: -1rem !important;
        width: calc(100% + 2rem) !important
    }
    
    .bg-gray-50 {
        border-radius: 0.375rem !important;
        padding: 1rem !important
    }
    
    .space-y-2 {
        padding: 0 1rem !important
    }
}

/* 스크롤바 숨기기 */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}
</style>

<script>
function showCompanyNews(companyId) {
    // 모든 뉴스 컨테이너 숨기기
    document.querySelectorAll('.company-news').forEach(el => {
        el.style.display = 'none';
    });
    
    // 선택된 언론사 뉴스만 보이기
    const selectedNews = document.getElementById(`news-${companyId}`);
    if (selectedNews) {
        selectedNews.style.display = 'block';
    }
    
    // 언론사 버튼 스타일 변경
    document.querySelectorAll('[data-company-id]').forEach(btn => {
        if (btn.dataset.companyId === companyId) {
            btn.classList.add('bg-blue-100', 'text-blue-600', 'font-medium');
            btn.classList.remove('bg-gray-100', 'text-gray-600');
        } else {
            btn.classList.remove('bg-blue-100', 'text-blue-600', 'font-medium');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        }
    });
}

// 슬라이더 기능 추가
document.addEventListener('DOMContentLoaded', function() {
    const companies = Array.from(document.querySelectorAll('[data-company-id]'));
    if (companies.length === 0) return;
    
    let currentIndex = 0;
    
    // 5초마다 다음 언론사로 전환
    setInterval(() => {
        currentIndex = (currentIndex + 1) % companies.length;
        const nextCompany = companies[currentIndex];
        if (nextCompany) {
            showCompanyNews(nextCompany.dataset.companyId);
        }
    }, 5000);
});
</script>
{% endblock extra_js %}
